<!DOCTYPE html>
<html>
  <body>
    <p id="status">Connection status will go here</p>
    <p id="transcript">Deepgram transcript will go here</p>
    <p id="translated">Translated text will go here</p>
    <script>
      const translateText = async (text) => {
        try {
          const response = await fetch('https://api-free.deepl.com/v2/translate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'Authorization': 'DEEPL_KEY'
            },
            body: new URLSearchParams({
              text: text,
              target_lang: 'NL',
            })
          });
          const result = await response.json();
          return result.translations[0].text;
        } catch (error) {
          console.error('Translation error:', error);
        }
      };

      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        const mediaRecorder = new MediaRecorder(stream);
        const socket = new WebSocket('wss://api.deepgram.com/v1/listen?language=es', [
          'token',
          'DEEP_GRAM_KEY'
        ]);

        socket.onopen = () => {
          console.log({ event: 'onopen' });
          document.querySelector('#status').textContent = 'Connected';
          mediaRecorder.addEventListener('dataavailable', (event) => {
            if (event.data.size > 0 && socket.readyState === 1) {
              socket.send(event.data);
            }
          });
          mediaRecorder.start(250);
        };

        socket.onmessage = async (message) => {
          console.log({ event: 'onmessage', message });
          const received = JSON.parse(message.data);
          const transcript = received.channel.alternatives[0].transcript;
          if (transcript && received.is_final) {
            const translated = await translateText(transcript);
            document.querySelector('#transcript').textContent += transcript + ' ';
            document.querySelector('#translated').textContent += translated + ' ';
          }
        };

        socket.onclose = () => {
          console.log({ event: 'onclose' });
        };

        socket.onerror = (error) => {
          console.log({ event: 'onerror', error });
        };
      });
    </script>
  </body>
</html>
